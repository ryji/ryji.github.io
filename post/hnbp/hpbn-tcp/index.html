<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>High-Performance Browser Networking 读书笔记-TCP - ryji's personal blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="ryji"><meta name=description content="引言 TCP/IP网络是互联网的核心，IP(Internet Protocal)提供了host-host的路由和寻址协议，TCP(Transmi"><meta name=keywords content="ryji,code,tracing,big-data"><meta name=generator content="Hugo 0.79.1 with theme even"><link rel=canonical href=http://ryji.github.io/post/hnbp/hpbn-tcp/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.2e81bbed97b8b282c1aeb57488cc71c8d8c8ec559f3931531bd396bf31e0d4dd.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="High-Performance Browser Networking 读书笔记-TCP"><meta property="og:description" content="引言 TCP/IP网络是互联网的核心，IP(Internet Protocal)提供了host-host的路由和寻址协议，TCP(Transmi"><meta property="og:type" content="article"><meta property="og:url" content="http://ryji.github.io/post/hnbp/hpbn-tcp/"><meta property="article:published_time" content="2021-02-06T22:43:58+08:00"><meta property="article:modified_time" content="2021-03-27T13:39:34+08:00"><meta itemprop=name content="High-Performance Browser Networking 读书笔记-TCP"><meta itemprop=description content="引言 TCP/IP网络是互联网的核心，IP(Internet Protocal)提供了host-host的路由和寻址协议，TCP(Transmi"><meta itemprop=datePublished content="2021-02-06T22:43:58+08:00"><meta itemprop=dateModified content="2021-03-27T13:39:34+08:00"><meta itemprop=wordCount content="2070"><meta itemprop=keywords content="TCP,network,"><meta name=twitter:card content="summary"><meta name=twitter:title content="High-Performance Browser Networking 读书笔记-TCP"><meta name=twitter:description content="引言 TCP/IP网络是互联网的核心，IP(Internet Protocal)提供了host-host的路由和寻址协议，TCP(Transmi"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>ryji's blog</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>ryji's blog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>High-Performance Browser Networking 读书笔记-TCP</h1><div class=post-meta><span class=post-time>2021-02-06</span><div class=post-category><a href=/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/>读书笔记</a></div><span class=more-meta>约 2070 字</span>
<span class=more-meta>预计阅读 5 分钟</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#引言>引言</a></li><li><a href=#tcp协议概述>TCP协议概述</a><ul><li><a href=#三次握手>三次握手</a></li><li><a href=#拥塞避免和控制>拥塞避免和控制</a><ul><li><a href=#flow-control>flow control</a></li><li><a href=#slow-start>slow-start</a></li><li><a href=#congestion-avoidance>congestion avoidance</a></li></ul></li></ul></li><li><a href=#带宽-时延乘积bandwidth-delay-product>带宽-时延乘积(bandwidth-delay product)</a></li><li><a href=#holhead-of-line-blocking>HOL(head of line) blocking</a></li><li><a href=#tcp协议优化>TCP协议优化</a><ul><li><a href=#tcp-服务器>TCP 服务器</a></li><li><a href=#应用>应用</a></li><li><a href=#checklist>Checklist</a></li></ul></li></ul></nav></div></div><div class=post-content><h1 id=引言>引言</h1><p>TCP/IP网络是互联网的核心，IP(Internet Protocal)提供了host-host的路由和寻址协议，TCP(Transmission Control Protocal)协议在不可靠的通信管道上建立了可靠的网络传输，保障接收端接收到的数据和发送端发送的数据内容和顺序一致。虽然协议没有要求，但如今大部分HTTP的实现都建立在TCP协议的基础上。</p><h1 id=tcp协议概述>TCP协议概述</h1><h2 id=三次握手>三次握手</h2><p>TCP协议建立连接时需要进行三次握手，如下表所示</p><table><thead><tr><th>发送端</th><th></th><th>接收端</th></tr></thead><tbody><tr><td>SYN (x=rand())</td><td>&mdash;&mdash;></td><td>-</td></tr><tr><td>-</td><td>&lt;&mdash;&mdash;</td><td>SYN ACK (x+1 y=rand())</td></tr><tr><td>ACK (y+1 x+1)</td><td>&mdash;&mdash;></td><td>-</td></tr></tbody></table><p>发送端在发送<code>ACK</code>之后就可以向接收端发送业务数据，接收端需要在接收到发送端的<code>ACK</code>之后才能向发送端发送业务数据。如果端到端通信的延时较大(例如：物理距离较远)，那么建立起TCP连接的耗时较长。因此，基于TCP协议的一个常用的优化方式是重用已经建立的连接。</p><p>TFO(TCP FAST OPEN, support on Linux 3.7+ kernel)技术可以在SYN packet中发送业务数据，降低部分因三次握手导致的延时。但这种技术只可以应用在部分类型的HTTP请求中，且SYN包中携带的数据包大小也有一定的限制。</p><h2 id=拥塞避免和控制>拥塞避免和控制</h2><h3 id=flow-control>flow control</h3><p>flow control是一种用来避免发送过多的数据导致接收端过载的机制，为了达到这一目的，通信的双方需要在每个ACK包中添加自身的<code>recieve window(rwnd)</code>，使得发送可以根据接收方的<code>rwnd</code>来调整发送速度。当<code>rwnd</code>降为0时，发送端停止向接收端发送数据，直到接收端将自身buffer中的数据处理完毕</p><p>最初版本的TCP协议为<code>rwnd</code>分配了16bit的空间，这样限定TCP通信过程中，双方的revieve buffer不能超过$ 2^{16} = 65536 $ bytes。随着应用对数据传输能力要求越来越高，RFC 1323提出 Window Scaling 技术，在ACK packet中将<code>rwnd</code>左移，recieve buffer提高到1G。</p><h3 id=slow-start>slow-start</h3><p>flow-control解决了通信双方不会导致对方过载的问题，但实际上网络中的各个节点处理能力和带宽各有差异。在通信建立时，发送/接收双方无法了解参与通信各个节点的处理能力；随着通信的进行，网络环境发生变化，这时候也需要持续调整数据传输速率来使用网络状况。1988年，Van Jacobson 和 Michael J. Karels 提供这个问题的几个算法，包括：slow-start, congestion avoidance, fast retransmit 和 fast recovery。</p><p>参数<code>congestion window (cwnd)</code>，这个参数限定了发送端在接收到ACK之前，可以发送数据的上限。因此，发送端未ACK的数据上限是$\min(cwnd, rwnd)$。slow-start，顾名思义，在连接建立时，<code>cwnd</code>取较小的值，随着数据传输的进行，逐渐调整，直到达到网络允许的最优带宽，目前的调整方式为指数增长，线性降低，如下图所示。由于slow-start的限制，在连接建立的最初，应用程序无法使用全部的带宽。自Linux 2.6.39+ kernel开始，<code>cwnd</code>的初始默认值已经调整为10 segments
<img src=slow-start.png alt=slow-start></p><p>SSR(Slow-Start Restart)指当TCP连接处于idle状态一段时间后，为了避免因idle期间网络状况发生改变导致拥塞，其<code>cwnd</code>会重置为一个较小的值。对于使用 HTTP keepalive 连接的应用来说，这个参数也会影响其性能。</p><h3 id=congestion-avoidance>congestion avoidance</h3><p>在实际的网络环境中，丢包(packet-loss)几乎是必然发生的。slow-start初始化一个较小的<code>cwnd</code>，然后随着每次ACK，将<code>cwnd</code>加倍，直到<code>cwnd</code>超过<code>rwnd</code>，或者<code>cwnd</code>超过系统上限，或者发生丢包。此时，congestion avoidance算法发挥作用，将<code>cwnd</code>适度减小，重复此过程，直到不再发生丢包。</p><h1 id=带宽-时延乘积bandwidth-delay-product>带宽-时延乘积(bandwidth-delay product)</h1><p>$$
数据传输速率 * 回环时延 = min(cwnd, rwnd)
$$</p><p>如果窗口size过小，即使可用带宽很大，但大多数时间中，发送/接收端是在等待ACK消息，系统实际的发送/接收速率并不高。如果目标传输速率为10Mbps, 回环时间为100ms，对应的最小窗口大小为$ (10 * 1000000)bps * 0.1s/(8 * 1024) = 122.1KB $。不启用 window scaling 时，默认的 window size 为 64KB</p><h1 id=holhead-of-line-blocking>HOL(head of line) blocking</h1><p>由于TCP的传输是有序且可信的，在传输过程中，如果有一个packet发生丢失，其后续所有的packet都需要等待丢失的packet重传到接收端后才能传输。这就是TCP的HOL问题。实际上，在TCP中，丢包是协议能达到最优性能所需反馈机制的重要组成部分。
如果应用能够容忍一部分丢包(音频、视频、游戏状态更新)，或者对时延比较敏感，可以改用UDP协议来传输数据，在应用层处理packet的乱序和丢失问题。WebRTC就选用UDP作为其基础协议。</p><h1 id=tcp协议优化>TCP协议优化</h1><ul><li>建立连接三次握手p的round-trip时延</li><li>新连接和长时间处于idle状态的连接的slow-start时延</li><li>拥塞控制和避免限制的吞吐率</li><li><code>cwnd</code>大小正比于吞吐率</li></ul><h2 id=tcp-服务器>TCP 服务器</h2><ul><li>初始 Congestion Window</li><li>Slow-Start Restart</li><li>Window Scaling</li><li>TCP Fast Open</li></ul><h2 id=应用>应用</h2><ul><li>尽可能减少需要传输的数据</li><li>我们不能让数据传输得更快，但可以将数据部署得离用户更近</li><li>重用可用的TCP连接时优化应用性能的重要手段</li></ul><h2 id=checklist>Checklist</h2><ul><li>升级内核版本 (Linux: 3.2+)</li><li><code>cwnd</code>初始大小设置为10</li><li>禁用 slow-start after idle</li><li>打开 that window scaling</li><li>避免多余的数据传输</li><li>对需要传输的数据进行压缩</li><li>将服务区放置得靠近用于(CDN)</li><li>重用可用的TCP连接</li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>ryji</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-03-27
<a href=https://github.com/ryji/ryji.github.io.git/commit/06e4c930b054d2656a8f697e7cf3f2a80cfc6f78 title="add stability pattern part2">(06e4c93)</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/tcp/>TCP</a>
<a href=/tags/network/>network</a></div><nav class=post-nav><a class=prev href=/post/hnbp/hpbn-udp/><i class="iconfont icon-left"></i><span class="prev-text nav-default">High-Performance Browser Networking 读书笔记-UDP</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/csharp/csharp_singleflight/><span class="next-text nav-default">C# version golang singleflight</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:ruoyangji@163.com class="iconfont icon-email" title=email></a><a href=https://github.com/ryji/ class="iconfont icon-github" title=github></a><a href=http://ryji.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2017 -
2021<span class=heart><i class="iconfont icon-heart"></i></span><span>ryji</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script><script type=text/javascript>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],}};</script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script></body></html>