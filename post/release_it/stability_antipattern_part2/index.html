<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Release It 读书笔记- stability antipatterns (part2) - ryji's personal blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="ryji"><meta name=description content="本文为 Release It! 第四章的笔记的第二部分，主要介绍服务/应用设计中可能引入的反模式 (antipatterns)，这些错误的设计会导致、加速系统的崩溃"><meta name=keywords content="ryji,code,tracing,big-data"><meta name=generator content="Hugo 0.79.1 with theme even"><link rel=canonical href=http://ryji.github.io/post/release_it/stability_antipattern_part2/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.2e81bbed97b8b282c1aeb57488cc71c8d8c8ec559f3931531bd396bf31e0d4dd.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Release It 读书笔记- stability antipatterns (part2)"><meta property="og:description" content="本文为 Release It! 第四章的笔记的第二部分，主要介绍服务/应用设计中可能引入的反模式 (antipatterns)，这些错误的设计会导致、加速系统的崩溃"><meta property="og:type" content="article"><meta property="og:url" content="http://ryji.github.io/post/release_it/stability_antipattern_part2/"><meta property="article:published_time" content="2021-03-14T21:47:37+08:00"><meta property="article:modified_time" content="2021-03-21T23:41:16+08:00"><meta itemprop=name content="Release It 读书笔记- stability antipatterns (part2)"><meta itemprop=description content="本文为 Release It! 第四章的笔记的第二部分，主要介绍服务/应用设计中可能引入的反模式 (antipatterns)，这些错误的设计会导致、加速系统的崩溃"><meta itemprop=datePublished content="2021-03-14T21:47:37+08:00"><meta itemprop=dateModified content="2021-03-21T23:41:16+08:00"><meta itemprop=wordCount content="2253"><meta itemprop=keywords content="stability,design,antipattern,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Release It 读书笔记- stability antipatterns (part2)"><meta name=twitter:description content="本文为 Release It! 第四章的笔记的第二部分，主要介绍服务/应用设计中可能引入的反模式 (antipatterns)，这些错误的设计会导致、加速系统的崩溃"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>ryji's blog</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>ryji's blog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Release It 读书笔记- stability antipatterns (part2)</h1><div class=post-meta><span class=post-time>2021-03-14</span><div class=post-category><a href=/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/>读书笔记</a>
<a href=/categories/release-it/>Release It</a></div><span class=more-meta>约 2253 字</span>
<span class=more-meta>预计阅读 5 分钟</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#blocked-threads-阻塞的线程>Blocked Threads (阻塞的线程)</a></li><li><a href=#self-denial-attacks-自我拒绝攻击>Self-Denial Attacks (自我拒绝攻击)</a></li><li><a href=#scaling-effects-扩展的影响>Scaling Effects (扩展的影响)</a></li><li><a href=#unbalanced-capacities-容量不平衡>Unbalanced Capacities (容量不平衡)</a></li><li><a href=#dogpile-瞬态负载>Dogpile (瞬态负载)</a></li><li><a href=#force-multiplier-影响倍增>Force Multiplier (影响倍增)</a></li><li><a href=#slow-responses-慢响应>Slow Responses (慢响应)</a></li><li><a href=#unbounded-result-sets-无界结果集>Unbounded Result Sets (无界结果集)</a></li></ul></li></ul></nav></div></div><div class=post-content><p>本文为 Release It! 第四章的笔记的第二部分，主要介绍服务/应用设计中可能引入的反模式 (antipatterns)，这些错误的设计会导致、加速系统的崩溃。在系统设计时，应尽可能地避免这些反模式。然而，错误是不可避免的，因此，还需要进一步了解这些错误发生后，会如何影响整个系统的运行。</p><h2 id=blocked-threads-阻塞的线程>Blocked Threads (阻塞的线程)</h2><p>在访问处理临界区的资源(cache, resource pool, 外部系统)时，线程会被其他同时访问此资源的线程阻塞。线程阻塞往往是随机出现的，出现的概率随着系统负载的增大而增大。在开发环境，由于系统的用户远低于生产环境的用户，很难发现此类问题。</p><p>在领域模型中使用线程同步方法是一种反模式，这种设计使得应用无法横向扩展。一种避免使用线程同步方法的设计是使领域模型对象不可变(immutable)，使用此对象进行查询和展示；当需要改变状态时，需要构造 Command 对象，也就是 CQRS(Command Query Responsibility Separation) 模式。
<strong>总结</strong></p><ul><li>阻塞的线程是大多数错误产生的最直接原因</li><li>仔细检查资源池</li><li>使用经过验证的多线程原语</li><li>使用 Timeouts 进行防御</li><li>留意引用的第三方库</li></ul><h2 id=self-denial-attacks-自我拒绝攻击>Self-Denial Attacks (自我拒绝攻击)</h2><p>Self-Denial Attacks是一种人和系统共同参与下发生的巧合，其结果类似于外部对系统进行攻击。</p><p>例如，超级话题，电商平台中 bug 优惠券、bug 价，都会使得系统在短期内产生对同一对象的大量请求。这些请求有可能会拖垮整个系统，导致失败。</p><p>处理这种问题的理想手段是使用 share-nothing 架构。然而，系统间总是需要共享部分数据。因此，在必须要共享资源时，尽可能地使用中间件进行解耦；在全局锁失效时，使用 fallback 方案进行处理(悲观锁->乐观锁)</p><p><strong>总结</strong></p><ul><li>保持沟通(商务事件)</li><li>保护共享资源</li><li>对热点数据快速重分配(热点数据自动多点备份，防止单机访问瓶颈)</li></ul><h2 id=scaling-effects-扩展的影响>Scaling Effects (扩展的影响)</h2><p>随着系统的横向扩展，一些在开发/测试环境中不存在的问题会逐渐在生产环境中暴露出来。</p><p>在非生产环境或者传统架构中，P2P 通信是一种常见的策略。但随着系统进行横向扩展，这种通信方式会导致O($N^2$)的数据流量，因此，推荐采用以下几种方式进行通信：</p><ul><li>UDP 广播(网络效率不高)</li><li>TCP/UDP 组播</li><li>publish/subscribe 模式</li><li>消息队列</li></ul><p>共享资源/服务，随着系统 scaling，会慢慢变成系统的瓶颈。需要尽可能减少资源的共享，做到share-nothing。</p><p><strong>总结</strong></p><ul><li>检查测试环境和生产环境的 scale 规模，确定是否会有 scaling effect</li><li>注意 P2P 通信</li><li>注意共享资源</li></ul><h2 id=unbalanced-capacities-容量不平衡>Unbalanced Capacities (容量不平衡)</h2><p>在生产环境中，访问前端服务的客户端(浏览器/App)可能数以百万计，在这种情况下，前端服务和后端服务、后端服务和后端服务之间都可能会发生负载不平衡的问题。随着系统的运行，热门和非热门的服务时刻变化，这进一步导致了不同系统之间的容量不平衡。热点事件的发生，也会加剧这种问题。</p><p><strong>总结</strong></p><ul><li>检查前后端服务器和线程数量的比例</li><li>注意 scaling 和用户对系统的影响</li><li>测试环境虚拟化，并对测试环境按生产环境等比例 scale up</li><li>前后端自测，检查系统在高负载/调用的系统停止响应时能否正常工作</li></ul><h2 id=dogpile-瞬态负载>Dogpile (瞬态负载)</h2><p>当一组服务同时暴露在瞬态的高负载下时，这种现象叫做 dogpile。它在如下情况下发生</p><ol><li>同时启动多个服务实例(代码更新、重启)</li><li>定时任务</li><li>配置信息变更后，配置系统推送配置变更消息（一些配置系统允许配置随机延迟时间来降低配置变更后配置系统被其他系统访问的并发量）</li><li>多线程被同一个信号量阻塞，当信号量恢复时，下游系统会产生较大的瞬态负载</li><li>大量缓存同时失效，对数据库系统的负载</li></ol><p><strong>总结</strong></p><ul><li>dogpile 导致系统必须处理不必要的高负载</li><li>使用随机的延时时间来分散请求</li><li>使用退避算法来避免脉冲式的负载压力</li></ul><h2 id=force-multiplier-影响倍增>Force Multiplier (影响倍增)</h2><p>随着系统运维自动化程序的提升，对系统进行变更造成的影响也随之倍增。特别的，在程序的控制面(control plane, 基础设施和应用元信息管理)产生的错误(数据不一致、数据损坏、误操作等)，往往会造成重大影响。</p><p>在这些控制面相关的系统中，可以采用如下的安全措施：</p><ol><li>如果发现大于 80% 的系统不可用，大概率是因为控制面系统不可用，而不是应用程序不可用</li><li>对危险操作进行滞后处理：快速启动新的节点(在公有云上，此举可能会产生巨额账单)，慢慢关闭不可用的节点</li><li>当期望的状态和实际状态差别过大时，需要人工确认后再进行自动操作</li><li>消耗资源的操作需要是有状态的，避免因消耗资源/资源检查时间不匹配导致问题(监测 container 的系统，在启动一个 container 用时 10 min，1s 进行一次 container 数量检查时，为了创建一个 container，可能会误创建 $10*60=600$ 个container)</li><li>创建统计资源缓冲区，假定系统过载检查 1s 一次，在需要 5min 来创建VM时，确保不会创建 300 个新的VM</li></ol><p><strong>总结</strong></p><ul><li>在修改生产环境前寻求帮助</li><li>注意创建资源滞后时间 和 资源统计间隔时间 不匹配的影响</li><li>注意控制系统的不可靠性</li></ul><h2 id=slow-responses-慢响应>Slow Responses (慢响应)</h2><p>导致系统慢响应的原因通常是系统接受了过多的请求。当所有的资源都用于忙碌状态时，无法创建新的资源来处理新的请求。另外，由于内存泄漏导致系统不停进行GC也会导致慢响应；网络拥塞、Socket buffer 区被撑爆也会导致系统慢响应。</p><p>系统应有能力判断自身的响应时间是否达到SLA，当无法达到时，对新的请求，应及时拒绝(应用层/传输层均可实现)。当然，因无法达到SLA的拒绝应放在接口文档中，并征得系统调用方的同意。</p><p><strong>总结</strong></p><ul><li>慢响应导致级联失败</li><li>对于网站来说，慢响应导致更多的网络压力(用户点击刷新按钮)</li><li>考虑快速失败 (Fail Fast)</li><li>注意内存泄漏和资源竞争导致的慢响应</li></ul><h2 id=unbounded-result-sets-无界结果集>Unbounded Result Sets (无界结果集)</h2><p>在访问其他系统(数据库，数据查询接口)时，需要显式限定返回数据的大小，防止因编程bug、约定修改等原因获得远超预期的数据，最终在对数据进行处理时内存耗尽导致程序崩溃。</p><p><strong>总结</strong></p><ul><li>使用真实环境的数据集</li><li>前端分页</li><li>不要依赖数据提供方分页</li><li>在应用协议中限定返回数据的大小</li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>ryji</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2021-03-21
<a href=https://github.com/ryji/ryji.github.io.git/commit/61300fdc19a98d77f42d02fb0ab43f319ed4bf4b title="update summary style">(61300fd)</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/stability/>stability</a>
<a href=/tags/design/>design</a>
<a href=/tags/antipattern/>antipattern</a></div><nav class=post-nav><a class=prev href=/post/kafka/kafka_basic_intro/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Kafka basic intro</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/post/release_it/stability_antipattern_part1/><span class="next-text nav-default">Release It 读书笔记- stability antipatterns (part1)</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:ruoyangji@163.com class="iconfont icon-email" title=email></a><a href=https://github.com/ryji/ class="iconfont icon-github" title=github></a><a href=http://ryji.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2017 -
2021<span class=heart><i class="iconfont icon-heart"></i></span><span>ryji</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script><script type=text/javascript>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],}};</script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script></body></html>